<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>ActivityThread中关于GC的操作 | Hexo</title>
  <meta name="description" content="1. 什么时候调用updateOomAdjLocked() 进行回收？首先，所有进程的创建均涉及AT的main()方法 123456public static void main(String[] args) &amp;#123;           ActivityThread thread = new ActivityThread();      thread.attach(false);  &amp;#12">
<meta name="keywords" content="GC">
<meta property="og:type" content="article">
<meta property="og:title" content="ActivityThread中关于GC的操作">
<meta property="og:url" content="http://yoursite.com/2020/06/28/ActivityThread-GC/index.html">
<meta property="og:site_name" content="tracyliu">
<meta property="og:description" content="1. 什么时候调用updateOomAdjLocked() 进行回收？首先，所有进程的创建均涉及AT的main()方法 123456public static void main(String[] args) &amp;#123;           ActivityThread thread = new ActivityThread();      thread.attach(false);  &amp;#12">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-06-29T07:49:26.778Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ActivityThread中关于GC的操作">
<meta name="twitter:description" content="1. 什么时候调用updateOomAdjLocked() 进行回收？首先，所有进程的创建均涉及AT的main()方法 123456public static void main(String[] args) &amp;#123;           ActivityThread thread = new ActivityThread();      thread.attach(false);  &amp;#12">
  <!-- Canonical links -->
  <link rel="canonical" href="http://yoursite.com/2020/06/28/ActivityThread-GC/index.html">
  
    <link rel="alternate" href="/atom.xml" title="tracyliu" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/cofess" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">昵称</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Web Developer &amp; Designer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Books</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/cofess" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      

    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AV/">AV</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-VM/">Android VM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android开发艺术探索/">Android开发艺术探索</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android调试/">Android调试</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dalvik/">Dalvik</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GC/">GC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/">Gradle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PowerManagerService/">PowerManagerService</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/framework/">framework</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leakcanary/">leakcanary</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/音视频/">音视频</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AV/" style="font-size: 13px;">AV</a> <a href="/tags/Android-VM/" style="font-size: 14px;">Android VM</a> <a href="/tags/Android开发艺术探索/" style="font-size: 13px;">Android开发艺术探索</a> <a href="/tags/Android调试/" style="font-size: 13px;">Android调试</a> <a href="/tags/Dalvik/" style="font-size: 13px;">Dalvik</a> <a href="/tags/GC/" style="font-size: 13px;">GC</a> <a href="/tags/Gradle/" style="font-size: 13px;">Gradle</a> <a href="/tags/PowerManagerService/" style="font-size: 13px;">PowerManagerService</a> <a href="/tags/framework/" style="font-size: 14px;">framework</a> <a href="/tags/leakcanary/" style="font-size: 14px;">leakcanary</a> <a href="/tags/ubuntu/" style="font-size: 13px;">ubuntu</a> <a href="/tags/音视频/" style="font-size: 13px;">音视频</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2020/11/05/tracyliu-resume/" class="title">tracyliu_resume</a>
              </p>
              <p class="item-date">
                <time datetime="2020-11-05T08:38:08.000Z" itemprop="datePublished">2020-11-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2020/11/05/auto-brightness-control-Android/" class="title">Android7.0自动亮度调节分析</a>
              </p>
              <p class="item-date">
                <time datetime="2020-11-05T08:31:58.000Z" itemprop="datePublished">2020-11-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2020/07/15/Android-VM-02-Dalvik/" class="title">Android VM 02.Davilk 启动 内存 GC</a>
              </p>
              <p class="item-date">
                <time datetime="2020-07-15T14:52:44.000Z" itemprop="datePublished">2020-07-15</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2020/07/15/Android-VM-01-JVM-DVM-introduce/" class="title">Android VM 01 JVM 、DVM、ART简介</a>
              </p>
              <p class="item-date">
                <time datetime="2020-07-15T14:49:28.000Z" itemprop="datePublished">2020-07-15</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2020/06/28/ActivityThread-GC/" class="title">ActivityThread中关于GC的操作</a>
              </p>
              <p class="item-date">
                <time datetime="2020-06-28T15:22:57.000Z" itemprop="datePublished">2020-06-28</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-ActivityThread-GC" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      ActivityThread中关于GC的操作
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/06/28/ActivityThread-GC/" class="article-date">
	  <time datetime="2020-06-28T15:22:57.000Z" itemprop="datePublished">2020-06-28</time>
	</a>
</span>
        
        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/GC/">GC</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/06/28/ActivityThread-GC/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h3 id="1-什么时候调用updateOomAdjLocked-进行回收？"><a href="#1-什么时候调用updateOomAdjLocked-进行回收？" class="headerlink" title="1. 什么时候调用updateOomAdjLocked() 进行回收？"></a>1. 什么时候调用updateOomAdjLocked() 进行回收？</h3><p>首先，所有进程的创建均涉及AT的main()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">     </span><br><span class="line">      ActivityThread thread = new ActivityThread();</span><br><span class="line">      thread.attach(false);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="attach"><a href="#attach" class="headerlink" title="attach()"></a>attach()</h4><p>BinderInternal.addGcWatcher 添加gc watcher对象，当Davilk内存占用大于3/4时，会执行releaseSomeActivity()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void attach(boolean system) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> // Watch for getting close to heap limit.</span><br><span class="line">          BinderInternal.addGcWatcher(new Runnable() &#123;</span><br><span class="line">              @Override public void run() &#123;</span><br><span class="line">                  if (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                      return;</span><br><span class="line">                  &#125;</span><br><span class="line">                  Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                  long dalvikMax = runtime.maxMemory();</span><br><span class="line">                  long dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                  if (dalvikUsed &gt; ((3*dalvikMax)/4)) &#123;</span><br><span class="line">                      if (DEBUG_MEMORY_TRIM) Slog.d(TAG, &quot;Dalvik max=&quot; + (dalvikMax/1024)</span><br><span class="line">                              + &quot; total=&quot; + (runtime.totalMemory()/1024)</span><br><span class="line">                              + &quot; used=&quot; + (dalvikUsed/1024));</span><br><span class="line">                      mSomeActivitiesChanged = false;</span><br><span class="line">                      try &#123;</span><br><span class="line">                          mgr.releaseSomeActivities(mAppThread);</span><br><span class="line">                      &#125; catch (RemoteException e) &#123;</span><br><span class="line">                          throw e.rethrowFromSystemServer();</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AMS-releaseSomeActivities"><a href="#AMS-releaseSomeActivities" class="headerlink" title="AMS#releaseSomeActivities()"></a>AMS#releaseSomeActivities()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void releaseSomeActivities(IApplicationThread appInt) &#123;</span><br><span class="line">       synchronized(this) &#123;</span><br><span class="line">           final long origId = Binder.clearCallingIdentity();</span><br><span class="line">           try &#123;</span><br><span class="line">               ProcessRecord app = getRecordForAppLocked(appInt);</span><br><span class="line">               mStackSupervisor.releaseSomeActivitiesLocked(app, &quot;low-mem&quot;);</span><br><span class="line">           &#125; finally &#123;</span><br><span class="line">               Binder.restoreCallingIdentity(origId);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="ASS-releaseSomeActivitiesLocked"><a href="#ASS-releaseSomeActivitiesLocked" class="headerlink" title="ASS#releaseSomeActivitiesLocked()"></a>ASS#releaseSomeActivitiesLocked()</h4><p>以下情况均不执行</p>
<ul>
<li>如果发现正在执行destory的Activity </li>
<li>如果一个activity处于不可销毁的状态</li>
<li>如果当前进程只有一个taskrecord不执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">void releaseSomeActivitiesLocked(ProcessRecord app, String reason) &#123;</span><br><span class="line">    // Examine all activities currently running in the process.</span><br><span class="line">    TaskRecord firstTask = null;</span><br><span class="line">    // Tasks is non-null only if two or more tasks are found.</span><br><span class="line">    ArraySet&lt;TaskRecord&gt; tasks = null;</span><br><span class="line">    if (DEBUG_RELEASE) Slog.d(TAG_RELEASE, &quot;Trying to release some activities in &quot; + app);</span><br><span class="line">    for (int i = 0; i &lt; app.activities.size(); i++) &#123;</span><br><span class="line">        ActivityRecord r = app.activities.get(i);</span><br><span class="line">        // First, if we find an activity that is in the process of being destroyed,</span><br><span class="line">        // then we just aren&apos;t going to do anything for now; we want things to settle</span><br><span class="line">        // down before we try to prune more activities.</span><br><span class="line">        //如果正在finishing  destorying destoryed 不继续执行</span><br><span class="line">        if (r.finishing || r.state == DESTROYING || r.state == DESTROYED) &#123;</span><br><span class="line">            if (DEBUG_RELEASE) Slog.d(TAG_RELEASE, &quot;Abort release; already destroying: &quot; + r);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // Don&apos;t consider any activies that are currently not in a state where they</span><br><span class="line">        // can be destroyed.</span><br><span class="line">        //如果一个activity处于不可销毁的状态</span><br><span class="line">        if (r.visible || !r.stopped || !r.haveState || r.state == RESUMED || r.state == PAUSING</span><br><span class="line">                || r.state == PAUSED || r.state == STOPPING) &#123;</span><br><span class="line">            if (DEBUG_RELEASE) Slog.d(TAG_RELEASE, &quot;Not releasing in-use activity: &quot; + r);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        if (r.task != null) &#123;</span><br><span class="line">        </span><br><span class="line">            if (DEBUG_RELEASE) Slog.d(TAG_RELEASE, &quot;Collecting release task &quot; + r.task</span><br><span class="line">                    + &quot; from &quot; + r);</span><br><span class="line">            if (firstTask == null) &#123;</span><br><span class="line">                firstTask = r.task;</span><br><span class="line">            &#125; else if (firstTask != r.task) &#123;</span><br><span class="line">                if (tasks == null) &#123;</span><br><span class="line">                    tasks = new ArraySet&lt;&gt;();</span><br><span class="line">                    tasks.add(firstTask);</span><br><span class="line">                &#125;</span><br><span class="line">                tasks.add(r.task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     // APP当前进程中，至少两个TaskRecord才有必要走Activity的销毁逻辑</span><br><span class="line">    if (tasks == null) &#123;</span><br><span class="line">        if (DEBUG_RELEASE) Slog.d(TAG_RELEASE, &quot;Didn&apos;t find two or more tasks to release&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    // If we have activities in multiple tasks that are in a position to be destroyed,</span><br><span class="line">    // let&apos;s iterate through the tasks and release the oldest one.</span><br><span class="line">    final int numDisplays = mActivityDisplays.size();</span><br><span class="line">    for (int displayNdx = 0; displayNdx &lt; numDisplays; ++displayNdx) &#123;</span><br><span class="line">        final ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        // Step through all stacks starting from behind, to hit the oldest things first.</span><br><span class="line">        for (int stackNdx = 0; stackNdx &lt; stacks.size(); stackNdx++) &#123;</span><br><span class="line">            final ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            // Try to release activities in this stack; if we manage to, we are done.</span><br><span class="line">            if (stack.releaseSomeActivitiesLocked(app, tasks, reason) &gt; 0) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AS-releaseSomeActivitiesLocked"><a href="#AS-releaseSomeActivitiesLocked" class="headerlink" title="AS#releaseSomeActivitiesLocked()"></a>AS#releaseSomeActivitiesLocked()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">final int releaseSomeActivitiesLocked(ProcessRecord app, ArraySet&lt;TaskRecord&gt; tasks,</span><br><span class="line">           String reason) &#123;</span><br><span class="line">       // Iterate over tasks starting at the back (oldest) first.</span><br><span class="line">       if (DEBUG_RELEASE) Slog.d(TAG_RELEASE, &quot;Trying to release some activities in &quot; + app);</span><br><span class="line">       int maxTasks = tasks.size() / 4;</span><br><span class="line">       if (maxTasks &lt; 1) &#123;</span><br><span class="line">           maxTasks = 1;</span><br><span class="line">       &#125;</span><br><span class="line">       int numReleased = 0;</span><br><span class="line">       for (int taskNdx = 0; taskNdx &lt; mTaskHistory.size() &amp;&amp; maxTasks &gt; 0; taskNdx++) &#123;</span><br><span class="line">           final TaskRecord task = mTaskHistory.get(taskNdx);</span><br><span class="line">           if (!tasks.contains(task)) &#123;</span><br><span class="line">               continue;</span><br><span class="line">           &#125;</span><br><span class="line">           if (DEBUG_RELEASE) Slog.d(TAG_RELEASE, &quot;Looking for activities to release in &quot; + task);</span><br><span class="line">           int curNum = 0;</span><br><span class="line">           final ArrayList&lt;ActivityRecord&gt; activities = task.mActivities;</span><br><span class="line">           for (int actNdx = 0; actNdx &lt; activities.size(); actNdx++) &#123;</span><br><span class="line">               final ActivityRecord activity = activities.get(actNdx);</span><br><span class="line">               //判断如果可以destory</span><br><span class="line">               if (activity.app == app &amp;&amp; activity.isDestroyable()) &#123;</span><br><span class="line">                   if (DEBUG_RELEASE) Slog.v(TAG_RELEASE, &quot;Destroying &quot; + activity</span><br><span class="line">                           + &quot; in state &quot; + activity.state + &quot; resumed=&quot; + mResumedActivity</span><br><span class="line">                           + &quot; pausing=&quot; + mPausingActivity + &quot; for reason &quot; + reason);</span><br><span class="line">                   destroyActivityLocked(activity, true, reason);</span><br><span class="line">                   if (activities.get(actNdx) != activity) &#123;</span><br><span class="line">                       // Was removed from list, back up so we don&apos;t miss the next one.</span><br><span class="line">                       actNdx--;</span><br><span class="line">                   &#125;</span><br><span class="line">                   curNum++;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           if (curNum &gt; 0) &#123;</span><br><span class="line">               numReleased += curNum;</span><br><span class="line">               maxTasks--;</span><br><span class="line">               if (mTaskHistory.get(taskNdx) != task) &#123;</span><br><span class="line">                   // The entire task got removed, back up so we don&apos;t miss the next one.</span><br><span class="line">                   taskNdx--;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       if (DEBUG_RELEASE) Slog.d(TAG_RELEASE,</span><br><span class="line">               &quot;Done releasing: did &quot; + numReleased + &quot; activities&quot;);</span><br><span class="line">       return numReleased;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="destroyActivityLocked-activity-true-reason"><a href="#destroyActivityLocked-activity-true-reason" class="headerlink" title="destroyActivityLocked(activity, true, reason)"></a>destroyActivityLocked(activity, true, reason)</h5><ul>
<li>mService.updateLruProcessLocked(r.app, false, null);</li>
<li>mService.updateOomAdjLocked();</li>
<li>调用AT#scheduleDestroyActivity</li>
</ul>
<hr>
<h2 id="2-分析BinderInternal"><a href="#2-分析BinderInternal" class="headerlink" title="2.分析BinderInternal"></a>2.分析BinderInternal</h2><p>BinderInternal内部有sGcWatchers对应一个runnable list，<br>BinderInternal重写了finalize()方法。</p>
<h5 id="根据JVM的原理，JVM垃圾回收器准备释放内存前，会先调用该对象finalize。"><a href="#根据JVM的原理，JVM垃圾回收器准备释放内存前，会先调用该对象finalize。" class="headerlink" title="根据JVM的原理，JVM垃圾回收器准备释放内存前，会先调用该对象finalize。"></a>根据JVM的原理，JVM垃圾回收器准备释放内存前，会先调用该对象finalize。</h5><p>当执行GC的时候，会依次执行每个runnabe的run()方法，并根据具体内存情况（3/4 davilk memory）进行操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class BinderInternal &#123;</span><br><span class="line">    static WeakReference&lt;GcWatcher&gt; sGcWatcher</span><br><span class="line">            = new WeakReference&lt;GcWatcher&gt;(new GcWatcher());</span><br><span class="line">    static ArrayList&lt;Runnable&gt; sGcWatchers = new ArrayList&lt;&gt;(); //</span><br><span class="line">    static Runnable[] sTmpWatchers = new Runnable[1]; //数组</span><br><span class="line">    static long sLastGcTime;</span><br><span class="line"></span><br><span class="line">    static final class GcWatcher &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected void finalize() throws Throwable &#123;</span><br><span class="line">            handleGc();</span><br><span class="line">            sLastGcTime = SystemClock.uptimeMillis();</span><br><span class="line">            synchronized (sGcWatchers) &#123;</span><br><span class="line">                sTmpWatchers = sGcWatchers.toArray(sTmpWatchers);</span><br><span class="line">            &#125;</span><br><span class="line">            for (int i=0; i&lt;sTmpWatchers.length; i++) &#123;</span><br><span class="line">                if (sTmpWatchers[i] != null) &#123;</span><br><span class="line">                    sTmpWatchers[i].run();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sGcWatcher = new WeakReference&lt;GcWatcher&gt;(new GcWatcher());</span><br><span class="line">            /*finallize方法最后重新创建了一个GcWatcher的弱引用。sGcWatcher是一个静态对象，</span><br><span class="line">            如果它是一个强引用，那么他就会存在静态引用方法区，就会导致这个强引用的GC线程无法回收。</span><br><span class="line">            所以作为弱引用，引用对象在被回收时就会触发sGcWatcher的finalize方法，执行结束时仔new一个弱引用出来，以保证下次的调用。*/</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    public static void forceGc(String reason) &#123;</span><br><span class="line">        EventLog.writeEvent(2741, reason);</span><br><span class="line">        VMRuntime.getRuntime().requestConcurrentGC();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-关于ActivityThread-forceGC"><a href="#3-关于ActivityThread-forceGC" class="headerlink" title="3.关于ActivityThread#forceGC"></a>3.关于ActivityThread#forceGC</h3><p>AT种有两处调用forceGC,reason分别是“bg” 和 “mem”</p>
<h4 id="3-1-BinderInternal-forceGc-“mem”"><a href="#3-1-BinderInternal-forceGc-“mem”" class="headerlink" title="3.1 BinderInternal.forceGc(“mem”)"></a>3.1 BinderInternal.forceGc(“mem”)</h4><h5 id="关注AMS-scheduleAppGcsLocked"><a href="#关注AMS-scheduleAppGcsLocked" class="headerlink" title="关注AMS#scheduleAppGcsLocked()"></a>关注AMS#scheduleAppGcsLocked()</h5><p>该方法分别在以下情况被调用</p>
<ul>
<li>AMS#doLowMemReportIfNeededLocked  lowmemory时候</li>
<li>windowsVisibleLocked   window可见变化</li>
<li>BroadcastQueue#processNextBroadcast 处理完广播 size = 0</li>
</ul>
<p>判断mProcessesToGc数量大于0，发送GC_BACKGROUND_PROCESSES_MSG<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Schedule the execution of all pending app GCs.</span><br><span class="line">    */</span><br><span class="line">   final void scheduleAppGcsLocked() &#123;</span><br><span class="line">       mHandler.removeMessages(GC_BACKGROUND_PROCESSES_MSG);</span><br><span class="line"></span><br><span class="line">       if (mProcessesToGc.size() &gt; 0) &#123;</span><br><span class="line">           // Schedule a GC for the time to the next process.</span><br><span class="line">           ProcessRecord proc = mProcessesToGc.get(0);</span><br><span class="line">           Message msg = mHandler.obtainMessage(GC_BACKGROUND_PROCESSES_MSG);</span><br><span class="line"></span><br><span class="line">           long when = proc.lastRequestedGc + GC_MIN_INTERVAL;</span><br><span class="line">           long now = SystemClock.uptimeMillis();</span><br><span class="line">           if (when &lt; (now+GC_TIMEOUT)) &#123;</span><br><span class="line">               when = now + GC_TIMEOUT;</span><br><span class="line">           &#125;</span><br><span class="line">           mHandler.sendMessageAtTime(msg, when);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>performAppGcsIfAppropriateLocked()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">case GC_BACKGROUND_PROCESSES_MSG: &#123;</span><br><span class="line">                synchronized (ActivityManagerService.this) &#123;</span><br><span class="line">                    performAppGcsIfAppropriateLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; break;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * If all looks good, perform GCs on all processes waiting for them.</span><br><span class="line">  */</span><br><span class="line"> final void performAppGcsIfAppropriateLocked() &#123;</span><br><span class="line">     if (canGcNowLocked()) &#123; //判断是否可以GC，根据广播 sleep 等判断</span><br><span class="line">         performAppGcsLocked();</span><br><span class="line">         return;</span><br><span class="line">     &#125;</span><br><span class="line">     // Still not idle, wait some more.</span><br><span class="line">     scheduleAppGcsLocked();  //不可以则等待</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> performAppGcsLocked()，根据时间判断当前时间和上次时间+GC默认间隔做判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Perform GCs on all processes that are waiting for it, but only</span><br><span class="line">   * if things are idle.</span><br><span class="line">   */</span><br><span class="line">  final void performAppGcsLocked() &#123;</span><br><span class="line">      final int N = mProcessesToGc.size();</span><br><span class="line">      if (N &lt;= 0) &#123;</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">      if (canGcNowLocked()) &#123;</span><br><span class="line">          while (mProcessesToGc.size() &gt; 0) &#123;</span><br><span class="line">              ProcessRecord proc = mProcessesToGc.remove(0);</span><br><span class="line">              if (proc.curRawAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ || proc.reportLowMemory) &#123;</span><br><span class="line">              //如果上次GC时间 + 最小GC间隔 小于等于 现在时间</span><br><span class="line">                  if ((proc.lastRequestedGc+GC_MIN_INTERVAL)</span><br><span class="line">                          &lt;= SystemClock.uptimeMillis()) &#123;</span><br><span class="line">                      // To avoid spamming the system, we will GC processes one</span><br><span class="line">                      // at a time, waiting a few seconds between each.</span><br><span class="line">                      performAppGcLocked(proc); //准备GC</span><br><span class="line">                      scheduleAppGcsLocked();//等待</span><br><span class="line">                      return;</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      // It hasn&apos;t been long enough since we last GCed this</span><br><span class="line">                      // process...  put it in the list to wait for its time.</span><br><span class="line">                      addProcessToGcListLocked(proc);</span><br><span class="line">                      break;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          scheduleAppGcsLocked();//等待</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p> performAppGcLocked(proc)<a href=""></a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Ask a given process to GC right now.</span><br><span class="line">  */</span><br><span class="line"> final void performAppGcLocked(ProcessRecord app) &#123;</span><br><span class="line">     try &#123;</span><br><span class="line">         app.lastRequestedGc = SystemClock.uptimeMillis();</span><br><span class="line">         if (app.thread != null) &#123;</span><br><span class="line">             if (app.reportLowMemory) &#123;</span><br><span class="line">                 app.reportLowMemory = false;</span><br><span class="line">                 app.thread.scheduleLowMemory(); //如果是lowmemory</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 app.thread.processInBackground();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; catch (Exception e) &#123;</span><br><span class="line">         // whatever.</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="AT-handleLowMemory"><a href="#AT-handleLowMemory" class="headerlink" title="AT#handleLowMemory()"></a>AT#handleLowMemory()</h4><p>处理了各级onLowMemory的回调，释放非system的sqlite 释放service，调用GC<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">final void handleLowMemory() &#123;</span><br><span class="line">     ArrayList&lt;ComponentCallbacks2&gt; callbacks = collectComponentCallbacks(true, null);</span><br><span class="line"></span><br><span class="line">     final int N = callbacks.size();</span><br><span class="line">     for (int i=0; i&lt;N; i++) &#123;</span><br><span class="line">         callbacks.get(i).onLowMemory();//各级执行onLowMemory回调</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // Ask SQLite to free up as much memory as it can, mostly from its page caches.</span><br><span class="line">     if (Process.myUid() != Process.SYSTEM_UID) &#123; //释放sqlite</span><br><span class="line">         int sqliteReleased = SQLiteDatabase.releaseMemory();</span><br><span class="line">         EventLog.writeEvent(SQLITE_MEM_RELEASED_EVENT_LOG_TAG, sqliteReleased);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // Ask graphics to free up as much as possible (font/image caches)</span><br><span class="line">     Canvas.freeCaches();//释放canvas</span><br><span class="line"></span><br><span class="line">     // Ask text layout engine to free also as much as possible</span><br><span class="line">     Canvas.freeTextLayoutCaches();</span><br><span class="line"></span><br><span class="line">     BinderInternal.forceGc(&quot;mem&quot;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="以上是BinderInternal-forceGc-“mem”"><a href="#以上是BinderInternal-forceGc-“mem”" class="headerlink" title="以上是BinderInternal.forceGc(“mem”);"></a>以上是BinderInternal.forceGc(“mem”);</h5><hr>
<h4 id="3-2-BinderInternal-forceGc-“bg”"><a href="#3-2-BinderInternal-forceGc-“bg”" class="headerlink" title="3.2 BinderInternal.forceGc(“bg”);"></a>3.2 BinderInternal.forceGc(“bg”);</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void scheduleGcIdler() &#123;</span><br><span class="line">      if (!mGcIdlerScheduled) &#123;</span><br><span class="line">          mGcIdlerScheduled = true;</span><br><span class="line">          Looper.myQueue().addIdleHandler(mGcIdler);</span><br><span class="line">      &#125;</span><br><span class="line">      mH.removeMessages(H.GC_WHEN_IDLE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  void unscheduleGcIdler() &#123;</span><br><span class="line">      if (mGcIdlerScheduled) &#123;</span><br><span class="line">          mGcIdlerScheduled = false;</span><br><span class="line">          Looper.myQueue().removeIdleHandler(mGcIdler);</span><br><span class="line">      &#125;</span><br><span class="line">      mH.removeMessages(H.GC_WHEN_IDLE);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="AT-processInBackground"><a href="#AT-processInBackground" class="headerlink" title="AT#processInBackground()"></a>AT#processInBackground()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void scheduleGcIdler() &#123;</span><br><span class="line">        if (!mGcIdlerScheduled) &#123;</span><br><span class="line">            mGcIdlerScheduled = true;</span><br><span class="line">            Looper.myQueue().addIdleHandler(mGcIdler);</span><br><span class="line">        &#125;</span><br><span class="line">        mH.removeMessages(H.GC_WHEN_IDLE);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>GcIdler实现了IdleHandler，内部执行doGcIfNeeded()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">final class GcIdler implements MessageQueue.IdleHandler &#123;</span><br><span class="line">       @Override</span><br><span class="line">       public final boolean queueIdle() &#123;</span><br><span class="line">           doGcIfNeeded();</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>mPendingIdleHandlers即是mGcIdler组成的数组</p>
<h6 id="MessageQueue"><a href="#MessageQueue" class="headerlink" title="MessageQueue"></a>MessageQueue</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">Message next() &#123;</span><br><span class="line">... // Run the idle handlers. // We only ever reach this code block during the first iteration.</span><br><span class="line">for (int i = 0; i &lt; pendingIdleHandlerCount; i++) &#123; </span><br><span class="line">final IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">mPendingIdleHandlers[i] = null; // release the reference to the handler boolean keep = false;</span><br><span class="line">try &#123; </span><br><span class="line"></span><br><span class="line">keep = idler.queueIdle();   </span><br><span class="line">    </span><br><span class="line">&#125; catch (Throwable t) &#123;</span><br><span class="line">Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t); </span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line">if (!keep) &#123;</span><br><span class="line">synchronized (this) &#123;</span><br><span class="line">mIdleHandlers.remove(idler); </span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line">&#125; &#125; ... &#125;</span><br></pre></td></tr></table></figure>
<p>由此可知在MessageQueue执行next方法时会调用queueIdle()<br>再来看doGcIfNeeded()<br>根据上次GC的时间加上两次GC间隔的最小时间5s，判断当前是否要GC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void doGcIfNeeded() &#123;</span><br><span class="line">        mGcIdlerScheduled = false;</span><br><span class="line">        final long now = SystemClock.uptimeMillis();</span><br><span class="line">        //Slog.i(TAG, &quot;**** WE MIGHT WANT TO GC: then=&quot; + Binder.getLastGcTime()</span><br><span class="line">        //        + &quot;m now=&quot; + now);</span><br><span class="line">        if ((BinderInternal.getLastGcTime()+MIN_TIME_BETWEEN_GCS) &lt; now) &#123;//默认5s</span><br><span class="line">            //Slog.i(TAG, &quot;**** WE DO, WE DO WANT TO GC!&quot;);</span><br><span class="line">            BinderInternal.forceGc(&quot;bg&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>#### </p>
<hr>
<p><a href="http://wossoneri.github.io/2019/11/18/[Android][Framework]Something-about-activity-recycle/#toc-heading-2" target="_blank" rel="noopener">关于Activity回收你要知道的事情</a></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://yoursite.com/2020/06/28/ActivityThread-GC/" title="ActivityThread中关于GC的操作" target="_blank" rel="external">http://yoursite.com/2020/06/28/ActivityThread-GC/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/cofess" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/cofess" target="_blank"><span class="text-dark">昵称</span><small class="ml-1x">Web Developer &amp; Designer</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2020/07/15/Android-VM-01-JVM-DVM-introduce/" title="Android VM 01 JVM 、DVM、ART简介"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2020/05/13/analyze-leakcanry2-0/" title="不深入的分析leakcanry2.0"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/cofess" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>