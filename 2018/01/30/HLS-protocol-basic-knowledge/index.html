
<!DOCTYPE html>
<html lang="zh-Hans">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="hls," />
  

  
    <meta name="description" content="it is a personal blogs" />
  
  
  <link rel="icon" type="image/x-icon" href="/logo.png">
  <title>HTTP Live Streaming (HLS) 协议科普扫盲 [ tracyliu ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
</head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="http://yoursite.com/images/logo.png">
    <span class="title">tracyliu</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">首页</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">标签</a></li>
          
      
          
            <li class="pure-menu-item"><a href="https://0xff000000.com" class="pure-menu-link">关于</a></li>
          
      
  </ul>
   
</nav>
  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        HTTP Live Streaming (HLS) 协议科普扫盲
      </h1>
      <span>
        
        <time class="time" datetime="2018-01-30T10:43:06.000Z">
        2018-01-30
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hls/">hls</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>
      <span class="read">阅读耗时 9 分钟</span>
    </header>

    <div class="post-content">
      <h3 id="HTTP-Live-Streaming"><a href="#HTTP-Live-Streaming" class="headerlink" title="HTTP Live Streaming:"></a>HTTP Live Streaming:</h3><p> HLS是一个由苹果公司提出的基于HTTP的<a href="https://zh.wikipedia.org/wiki/%E6%B5%81%E5%AA%92%E4%BD%93" target="_blank" rel="noopener">流媒体</a><a href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">网络传输协议</a>，可以实现流媒体的直播（live）和点播(vod)。</p>
<h5 id="HLS协议规定："><a href="#HLS协议规定：" class="headerlink" title="HLS协议规定："></a>HLS协议规定：</h5><blockquote>
<p>HLS协议由HTTP+M3U8+TS三部分组成，其中，HTTP是传输协议，M3U8是索引文件，TS是视音频的媒体信息。<br>视频的编码格式为H264,音频编码格式为MP3、AAC或者AC-3。</p>
</blockquote>
<h3 id="工作原理："><a href="#工作原理：" class="headerlink" title="工作原理："></a>工作原理：</h3><blockquote>
<p>把整个ts流分成一个个ts小文件供播放器按顺序下载播放。<br>在开始一个流媒体会话时，客户端会下载一个包含元数据的<a href="https://zh.wikipedia.org/w/index.php?title=Extended_M3U&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">extended M3U (m3u8)</a> <a href="https://zh.wikipedia.org/w/index.php?title=Playlist&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">playlist</a>文件，用于寻找可用的媒体流。<br><img src="http://upload-images.jianshu.io/upload_images/1984280-88f6ae5b4c00ae61?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="HLS 的请求流程"></p>
</blockquote>
<pre><code>1 http 请求 m3u8 的 url。
2 服务端返回一个 m3u8 的播放列表，这个播放列表是实时更新的，一般一次给出5段数据的 url。
3 客户端解析 m3u8 的播放列表，再按序请求每一段的 url，获取 ts 数据流。
</code></pre><p><img src="http://upload-images.jianshu.io/upload_images/1984280-393db5a721a3fc7c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1984280-ccb165b40606d30b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>Media encoder将视频源中的视频数据转码到目标编码格式（H264）的视频数据，之后，在stream segmenter模块将视频切片。切片的结果就是index file（m3u8）和ts文件。</p>
<p>####HLS的index文件（m3u8文件）<br><img src="http://upload-images.jianshu.io/upload_images/1984280-1a9607caa7d72134.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1984280-13edbf6aa98dd7a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="湖北卫视样例"></p>
<p>播放模式</p>
<blockquote>
<p>点播VOD的特点就是当前时间点可以获取到所有index文件和ts文件，二级index文件中记录了所有ts文件的地址。这种模式允许客户端访问全部内容。<br>Live 模式就是实时生成M3u8和ts文件。它的索引文件一直处于动态变化的，播放的时候需要不断下载二级index文件，以获得最新生成的ts文件播放视频。如果一个二级index文件的末尾没有#EXT-X-ENDLIST标志，说明它是一个Live视频流。<br>m3u8的Tag，太多了，这里就不一一说明。<br>播放器拿到该m3u8列表之后，会请求一片ts后，间隔一段时间请求下一片ts。 这个间隔的时间的长短，一般是根据m3u8中的 #EXT-X-TARGETDURATION</p>
</blockquote>
<h3 id="优势："><a href="#优势：" class="headerlink" title="优势："></a>优势：</h3><h5 id="1-码率自适应（Adaptive-Streaming）"><a href="#1-码率自适应（Adaptive-Streaming）" class="headerlink" title="1.码率自适应（Adaptive Streaming）"></a>1.码率自适应（Adaptive Streaming）</h5><blockquote>
<p>当媒体流正在播放时，客户端可以选择从许多不同的备用源中以不同的速率下载同样的资源，允许流媒体会话适应不同的数据速率。客户端可以很快的选择和切换码率，以适应不同带宽条件下的播放。</p>
</blockquote>
<h5 id="2-基于HTTP-穿墙-性能高"><a href="#2-基于HTTP-穿墙-性能高" class="headerlink" title="2.基于HTTP(穿墙/性能高)"></a>2.基于HTTP(穿墙/性能高)</h5><blockquote>
<p>HLS采取HTTP协议传输文件，所以可以穿过任何允许HTTP数据通过的防火墙或者代理服务器。相比之下，因为RTMP协议不使用标准的HTTP接口传输数据，所以在一些特殊的网络环境下可能被防火墙屏蔽掉。</p>
</blockquote>
<h5 id="3-跨平台性："><a href="#3-跨平台性：" class="headerlink" title="3.跨平台性："></a>3.跨平台性：</h5><blockquote>
<p>支持PC/Android/IOS平台，并在移动端趋势明显。（PC主要的直播方案是RTMP）</p>
</blockquote>
<h5 id="4-充分利用CDN（负载均衡）："><a href="#4-充分利用CDN（负载均衡）：" class="headerlink" title="4.充分利用CDN（负载均衡）："></a>4.充分利用CDN（负载均衡）：</h5><blockquote>
<p>CDN即Content Delivery Network （内容分发网络）。CDN包含两大核心技术：负载均衡和分发网络<br>于负载，RTMP是一种有状态协议，很难对视频服务器进行平滑扩展，因为需要为每一个播放视频流的客户端维护状态。而HLS基于无状态协议（HTTP），客户端只是按照顺序使用下载存储在服务器的普通TS文件，做负责均衡如同普通的HTTP文件服务器的负载均衡一样简单。</p>
</blockquote>
<h3 id="劣势："><a href="#劣势：" class="headerlink" title="劣势："></a>劣势：</h3><h5 id="1-实时性差："><a href="#1-实时性差：" class="headerlink" title="1.实时性差："></a>1.实时性差：</h5><blockquote>
<p>基本上HLS的延迟在10秒以上,而RTMP协议的延迟最低可以到3、4秒左右。</p>
<h5 id="2-文件碎片："><a href="#2-文件碎片：" class="headerlink" title="2.文件碎片："></a>2.文件碎片：</h5><p>若分发HLS，码流低，切片较小时，小文件分发不是很友好。特别是一些对存储比较敏感的情况，譬如源站的存储，嵌入式的SD卡。</p>
</blockquote>
<h4 id="HLS延时分析"><a href="#HLS延时分析" class="headerlink" title="HLS延时分析"></a>HLS延时分析</h4><blockquote>
<p>HLS理论上延时=1个切片的时长+ 0-1个td + 0-n个启动切片 +网络连接耗时。</p>
</blockquote>
<p>td是EXT-X-TARGETDURATION，可简单理解为播放器取片的间隔时间<br>n:苹果官方建议是请求到3个片之后才开始播放</p>
<p>假设列表里面的包含5个 ts 文件，每个 TS 文件包含5秒的视频内容，那么整体的延迟就是25秒。苹果官方推荐的ts时长时10s，所以这样就会大改有30s（n x 10）的延迟。</p>
<p>为了追求低延时效果，我们可以将切片切的更小，取片间隔做的更小，播放器未取到3个片就启动播放。极致来说可以缩减列表长度为1，并且 ts 的时长为1s，但是这样会造成请求次数增加，增大服务器压力，当网速慢时回造成更多的缓冲，增加HLS不稳定和出现错误的风险。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1984280-809ff2b6e0af4615.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="HLS 和 DASH 的区别"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1984280-7c790054216c2f35.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="hls 和 rtmp 对比"></p>
<p>参考：<br><a href="http://www.jianshu.com/p/426425cad08a" target="_blank" rel="noopener">HLS协议介绍</a><br><a href="http://www.jianshu.com/p/2ce402a485ca" target="_blank" rel="noopener">HTTP Live Streaming (HLS) - 概念</a><br><a href="http://befo.io/4447.html#respond" target="_blank" rel="noopener">0</a><a href="http://befo.io/4447.html" target="_blank" rel="noopener">流媒体｜从入门到出家：流媒体协议—HLS</a><br><a href="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=2653577297&amp;idx=1&amp;sn=a292ff3b499168f4eb589e40b7aa6d13&amp;mpshare=1&amp;scene=1&amp;srcid=0707bH9Td4NNpLVkkZlcTfHC#rd" target="_blank" rel="noopener">HTML 5 视频直播一站式扫盲</a></p>

    </div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Live-Streaming"><span class="toc-text"><a href="#HTTP-Live-Streaming" class="headerlink" title="HTTP Live Streaming:"></a>HTTP Live Streaming:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HLS协议规定："><span class="toc-text"><a href="#HLS&#x534F;&#x8BAE;&#x89C4;&#x5B9A;&#xFF1A;" class="headerlink" title="HLS&#x534F;&#x8BAE;&#x89C4;&#x5B9A;&#xFF1A;"></a>HLS&#x534F;&#x8BAE;&#x89C4;&#x5B9A;&#xFF1A;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工作原理："><span class="toc-text"><a href="#&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF1A;" class="headerlink" title="&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF1A;"></a>&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF1A;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优势："><span class="toc-text"><a href="#&#x4F18;&#x52BF;&#xFF1A;" class="headerlink" title="&#x4F18;&#x52BF;&#xFF1A;"></a>&#x4F18;&#x52BF;&#xFF1A;</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-码率自适应（Adaptive-Streaming）"><span class="toc-text"><a href="#1-&#x7801;&#x7387;&#x81EA;&#x9002;&#x5E94;&#xFF08;Adaptive-Streaming&#xFF09;" class="headerlink" title="1.&#x7801;&#x7387;&#x81EA;&#x9002;&#x5E94;&#xFF08;Adaptive Streaming&#xFF09;"></a>1.&#x7801;&#x7387;&#x81EA;&#x9002;&#x5E94;&#xFF08;Adaptive Streaming&#xFF09;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-基于HTTP-穿墙-性能高"><span class="toc-text"><a href="#2-&#x57FA;&#x4E8E;HTTP-&#x7A7F;&#x5899;-&#x6027;&#x80FD;&#x9AD8;" class="headerlink" title="2.&#x57FA;&#x4E8E;HTTP(&#x7A7F;&#x5899;/&#x6027;&#x80FD;&#x9AD8;)"></a>2.&#x57FA;&#x4E8E;HTTP(&#x7A7F;&#x5899;/&#x6027;&#x80FD;&#x9AD8;)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-跨平台性："><span class="toc-text"><a href="#3-&#x8DE8;&#x5E73;&#x53F0;&#x6027;&#xFF1A;" class="headerlink" title="3.&#x8DE8;&#x5E73;&#x53F0;&#x6027;&#xFF1A;"></a>3.&#x8DE8;&#x5E73;&#x53F0;&#x6027;&#xFF1A;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-充分利用CDN（负载均衡）："><span class="toc-text"><a href="#4-&#x5145;&#x5206;&#x5229;&#x7528;CDN&#xFF08;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF09;&#xFF1A;" class="headerlink" title="4.&#x5145;&#x5206;&#x5229;&#x7528;CDN&#xFF08;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF09;&#xFF1A;"></a>4.&#x5145;&#x5206;&#x5229;&#x7528;CDN&#xFF08;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF09;&#xFF1A;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#劣势："><span class="toc-text"><a href="#&#x52A3;&#x52BF;&#xFF1A;" class="headerlink" title="&#x52A3;&#x52BF;&#xFF1A;"></a>&#x52A3;&#x52BF;&#xFF1A;</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-实时性差："><span class="toc-text"><a href="#1-&#x5B9E;&#x65F6;&#x6027;&#x5DEE;&#xFF1A;" class="headerlink" title="1.&#x5B9E;&#x65F6;&#x6027;&#x5DEE;&#xFF1A;"></a>1.&#x5B9E;&#x65F6;&#x6027;&#x5DEE;&#xFF1A;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-文件碎片："><span class="toc-text"><a href="#2-&#x6587;&#x4EF6;&#x788E;&#x7247;&#xFF1A;" class="headerlink" title="2.&#x6587;&#x4EF6;&#x788E;&#x7247;&#xFF1A;"></a>2.&#x6587;&#x4EF6;&#x788E;&#x7247;&#xFF1A;</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HLS延时分析"><span class="toc-text"><a href="#HLS&#x5EF6;&#x65F6;&#x5206;&#x6790;" class="headerlink" title="HLS&#x5EF6;&#x65F6;&#x5206;&#x6790;"></a>HLS&#x5EF6;&#x65F6;&#x5206;&#x6790;</span></a></li></ol></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>
<div class="share" style="width: 100%;">
 
</div>

  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2018/01/29/Activity-LifeCycle-and-Launch-Mode/" rel="next" title="艺术探索—一、Activity的生命周期全面分析">
          艺术探索—一、Activity的生命周期全面分析
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2018/01/30/Instrumentation-click-drag-keycode-foucs-loss/" rel="prev" title="Android Instrumentation 模拟点击、拖拽、发送keycode、焦点异常丢失。">
            Android Instrumentation 模拟点击、拖拽、发送keycode、焦点异常丢失。
          </a>
          <span>〉</span>
        
      </div>
    </div>
  


    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" href="https://blog.0xff000000.com">首页</a> |
        <a class="bottom-item" href="" target="_blank">主站</a> |
        <a class="bottom-item" href="https://github.com/tracyliu1" target="_blank">GitHub</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu/hexo-theme-xoxo" target="_blank">Theme xoxo</a>
    </div>
</footer>
  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



</body>
</html>
